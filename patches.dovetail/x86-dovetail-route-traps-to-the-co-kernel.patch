From 57ddcd43680ecb5f9794d1d8184386594e8bcb8c Mon Sep 17 00:00:00 2001
From: Philippe Gerum <rpm@xenomai.org>
Date: Mon, 6 May 2019 17:59:42 +0200
Subject: [PATCH] x86: dovetail: route traps to the co-kernel

---
 arch/x86/include/asm/irq_pipeline.h |  4 ++--
 arch/x86/kernel/traps.c             | 18 ++++++++++--------
 arch/x86/mm/fault.c                 |  2 +-
 3 files changed, 13 insertions(+), 11 deletions(-)

diff --git a/arch/x86/include/asm/irq_pipeline.h b/arch/x86/include/asm/irq_pipeline.h
index 314704565141..f4ae6d9c3b20 100644
--- a/arch/x86/include/asm/irq_pipeline.h
+++ b/arch/x86/include/asm/irq_pipeline.h
@@ -88,7 +88,7 @@ static inline int arch_enable_oob_stage(void)
 	return 0;
 }
 
-unsigned long pipelined_fault_entry(struct pt_regs *regs);
+unsigned long pipelined_fault_entry(int trapnr, struct pt_regs *regs);
 
 void pipelined_fault_exit(unsigned long combo);
 
@@ -127,7 +127,7 @@ static inline notrace unsigned long arch_local_irq_save(void)
 }
 
 static inline
-unsigned long pipelined_fault_entry(struct pt_regs *regs)
+unsigned long pipelined_fault_entry(int trapnr, struct pt_regs *regs)
 {
 	return 0;
 }
diff --git a/arch/x86/kernel/traps.c b/arch/x86/kernel/traps.c
index 7dcf71270ac4..06159eb5c35a 100644
--- a/arch/x86/kernel/traps.c
+++ b/arch/x86/kernel/traps.c
@@ -76,11 +76,13 @@ DECLARE_BITMAP(system_vectors, NR_VECTORS);
 
 #ifdef CONFIG_IRQ_PIPELINE
 
-unsigned long pipelined_fault_entry(struct pt_regs *regs)
+unsigned long pipelined_fault_entry(int trapnr, struct pt_regs *regs)
 {
 	unsigned long flags;
 	int nosync = 1;
 
+	oob_trap_notify(trapnr, regs);
+
 	flags = hard_local_irq_save();
 
 	if (hard_irqs_disabled_flags(flags))
@@ -303,7 +305,7 @@ static void do_error_trap(struct pt_regs *regs, long error_code, char *str,
 {
 	unsigned long flags;
 
-	flags = pipelined_fault_entry(regs);
+	flags = pipelined_fault_entry(trapnr, regs);
 
 	RCU_LOCKDEP_WARN(!rcu_is_watching(), "entry code didn't wake RCU");
 
@@ -482,7 +484,7 @@ dotraplinkage void do_bounds(struct pt_regs *regs, long error_code)
 	const struct mpx_bndcsr *bndcsr;
 	unsigned long flags;
 
-	flags = pipelined_fault_entry(regs);
+	flags = pipelined_fault_entry(X86_TRAP_BR, regs);
 
 	RCU_LOCKDEP_WARN(!rcu_is_watching(), "entry code didn't wake RCU");
 	if (notify_die(DIE_TRAP, "bounds", regs, error_code,
@@ -578,7 +580,7 @@ do_general_protection(struct pt_regs *regs, long error_code)
 	RCU_LOCKDEP_WARN(!rcu_is_watching(), "entry code didn't wake RCU");
 	cond_local_irq_enable(regs);
 
-	flags = pipelined_fault_entry(regs);
+	flags = pipelined_fault_entry(X86_TRAP_GP, regs);
 
 	if (static_cpu_has(X86_FEATURE_UMIP)) {
 		if (user_mode(regs) && fixup_umip_exception(regs))
@@ -629,7 +631,7 @@ dotraplinkage void notrace do_int3(struct pt_regs *regs, long error_code)
 {
 	unsigned long flags;
 
-	flags = pipelined_fault_entry(regs);
+	flags = pipelined_fault_entry(X86_TRAP_BP, regs);
 
 #ifdef CONFIG_DYNAMIC_FTRACE
 	/*
@@ -832,7 +834,7 @@ dotraplinkage void do_debug(struct pt_regs *regs, long error_code)
 		goto exit;
 #endif
 
-	flags = pipelined_fault_entry(regs);
+	flags = pipelined_fault_entry(X86_TRAP_DB, regs);
 
 	if (notify_die(DIE_DEBUG, "debug", regs, (long)&dr6, error_code,
 							SIGTRAP) == NOTIFY_STOP)
@@ -893,7 +895,7 @@ static void math_error(struct pt_regs *regs, int error_code, int trapnr)
 	char *str = (trapnr == X86_TRAP_MF) ? "fpu exception" :
 						"simd exception";
 
-	flags = pipelined_fault_entry(regs);
+	flags = pipelined_fault_entry(trapnr, regs);
 
 	cond_local_irq_enable(regs);
 
@@ -959,7 +961,7 @@ do_device_not_available(struct pt_regs *regs, long error_code)
 	if (!boot_cpu_has(X86_FEATURE_FPU) && (cr0 & X86_CR0_EM)) {
 		struct math_emu_info info = { };
 
-		flags = pipelined_fault_entry(regs);
+		flags = pipelined_fault_entry(X86_TRAP_NM, regs);
 
 		cond_local_irq_enable(regs);
 
diff --git a/arch/x86/mm/fault.c b/arch/x86/mm/fault.c
index 2f3f928b0f1a..7a3aa1fd4adf 100644
--- a/arch/x86/mm/fault.c
+++ b/arch/x86/mm/fault.c
@@ -1549,7 +1549,7 @@ do_page_fault(struct pt_regs *regs, unsigned long error_code)
 	enum ctx_state prev_state;
 	unsigned long flags;
 
-	flags = pipelined_fault_entry(regs);
+	flags = pipelined_fault_entry(X86_TRAP_PF, regs);
 
 	prev_state = exception_enter();
 	if (trace_pagefault_enabled())
-- 
2.16.4

