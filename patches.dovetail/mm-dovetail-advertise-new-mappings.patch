From f4a2443df588b93daed4a5ba3cdaeb3f7d47ba1c Mon Sep 17 00:00:00 2001
From: Philippe Gerum <rpm@xenomai.org>
Date: Sun, 28 Apr 2019 15:35:03 +0200
Subject: [PATCH] mm: dovetail: advertise new mappings

---
 include/linux/vmalloc.h | 1 +
 lib/ioremap.c           | 1 +
 mm/vmalloc.c            | 6 ++++++
 3 files changed, 8 insertions(+)

diff --git a/include/linux/vmalloc.h b/include/linux/vmalloc.h
index 398e9c95cd61..0ffec1b0e425 100644
--- a/include/linux/vmalloc.h
+++ b/include/linux/vmalloc.h
@@ -205,5 +205,6 @@ pcpu_free_vm_areas(struct vm_struct **vms, int nr_vms)
 
 int register_vmap_purge_notifier(struct notifier_block *nb);
 int unregister_vmap_purge_notifier(struct notifier_block *nb);
+void arch_advertise_page_mapping(unsigned long start, unsigned long end);
 
 #endif /* _LINUX_VMALLOC_H */
diff --git a/lib/ioremap.c b/lib/ioremap.c
index 063213685563..1414a1a52905 100644
--- a/lib/ioremap.c
+++ b/lib/ioremap.c
@@ -216,6 +216,7 @@ int ioremap_page_range(unsigned long addr,
 			break;
 	} while (pgd++, phys_addr += (next - addr), addr = next, addr != end);
 
+	arch_advertise_page_mapping(start, end);
 	flush_cache_vmap(start, end);
 
 	return err;
diff --git a/mm/vmalloc.c b/mm/vmalloc.c
index e86ba6e74b50..b878cb5ebdf7 100644
--- a/mm/vmalloc.c
+++ b/mm/vmalloc.c
@@ -208,6 +208,10 @@ static int vmap_p4d_range(pgd_t *pgd, unsigned long addr,
 	return 0;
 }
 
+void __weak arch_advertise_page_mapping(unsigned long start, unsigned long end)
+{
+}
+
 /*
  * Set up page tables in kva (addr, end). The ptes shall have prot "prot", and
  * will have pfns corresponding to the "pages" array.
@@ -232,6 +236,8 @@ static int vmap_page_range_noflush(unsigned long start, unsigned long end,
 			return err;
 	} while (pgd++, addr = next, addr != end);
 
+	arch_advertise_page_mapping(start, end);
+
 	return nr;
 }
 
-- 
2.16.4

