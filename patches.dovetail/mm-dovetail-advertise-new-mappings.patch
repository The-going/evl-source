From 2c8249846adc5634de17356ff4f6165bb898c8f8 Mon Sep 17 00:00:00 2001
From: Philippe Gerum <rpm@xenomai.org>
Date: Sun, 28 Apr 2019 15:35:03 +0200
Subject: [PATCH] mm: dovetail: advertise new mappings

---
 include/linux/vmalloc.h | 1 +
 lib/ioremap.c           | 1 +
 mm/vmalloc.c            | 6 ++++++
 3 files changed, 8 insertions(+)

diff --git a/include/linux/vmalloc.h b/include/linux/vmalloc.h
index 4e7809408073..1d96a633dcc1 100644
--- a/include/linux/vmalloc.h
+++ b/include/linux/vmalloc.h
@@ -234,5 +234,6 @@ pcpu_free_vm_areas(struct vm_struct **vms, int nr_vms)
 
 int register_vmap_purge_notifier(struct notifier_block *nb);
 int unregister_vmap_purge_notifier(struct notifier_block *nb);
+void arch_advertise_page_mapping(unsigned long start, unsigned long end);
 
 #endif /* _LINUX_VMALLOC_H */
diff --git a/lib/ioremap.c b/lib/ioremap.c
index 0a2ffadc6d71..831540bdf5ea 100644
--- a/lib/ioremap.c
+++ b/lib/ioremap.c
@@ -227,6 +227,7 @@ int ioremap_page_range(unsigned long addr,
 			break;
 	} while (pgd++, phys_addr += (next - addr), addr = next, addr != end);
 
+	arch_advertise_page_mapping(start, end);
 	flush_cache_vmap(start, end);
 
 	return err;
diff --git a/mm/vmalloc.c b/mm/vmalloc.c
index a3c70e275f4e..4441275f2bf0 100644
--- a/mm/vmalloc.c
+++ b/mm/vmalloc.c
@@ -211,6 +211,10 @@ static int vmap_p4d_range(pgd_t *pgd, unsigned long addr,
 	return 0;
 }
 
+void __weak arch_advertise_page_mapping(unsigned long start, unsigned long end)
+{
+}
+
 /*
  * Set up page tables in kva (addr, end). The ptes shall have prot "prot", and
  * will have pfns corresponding to the "pages" array.
@@ -235,6 +239,8 @@ static int vmap_page_range_noflush(unsigned long start, unsigned long end,
 			return err;
 	} while (pgd++, addr = next, addr != end);
 
+	arch_advertise_page_mapping(start, end);
+
 	return nr;
 }
 
-- 
2.16.4

