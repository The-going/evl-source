From 6761efda194dd4b43caf3309421dfd03135f4ebe Mon Sep 17 00:00:00 2001
From: Philippe Gerum <rpm@xenomai.org>
Date: Sat, 13 Jul 2019 17:45:43 +0200
Subject: [PATCH] arm64: dovetail: inline trivial context switch helper

---
 arch/arm64/include/asm/dovetail.h |  7 ++++++-
 arch/arm64/kernel/Makefile        |  1 -
 arch/arm64/kernel/dovetail.c      | 12 ------------
 3 files changed, 6 insertions(+), 14 deletions(-)
 delete mode 100644 arch/arm64/kernel/dovetail.c

diff --git a/arch/arm64/include/asm/dovetail.h b/arch/arm64/include/asm/dovetail.h
index c9a51cd389c..4802df0c347 100644
--- a/arch/arm64/include/asm/dovetail.h
+++ b/arch/arm64/include/asm/dovetail.h
@@ -6,6 +6,8 @@
 #ifndef _ASM_ARM64_DOVETAIL_H
 #define _ASM_ARM64_DOVETAIL_H
 
+#include <asm/fpsimd.h>
+
 /* ARM64 traps */
 #define ARM64_TRAP_ACCESS	0	/* Data or instruction access exception */
 #define ARM64_TRAP_ABRT		1	/* Memory/alignment abort */
@@ -19,6 +21,9 @@
 static inline void arch_dovetail_switch_prepare(bool leave_inband)
 { }
 
-void arch_dovetail_switch_finish(bool enter_inband);
+static inline void arch_dovetail_switch_finish(bool enter_inband)
+{
+	fpsimd_restore_current_oob();
+}
 
 #endif /* _ASM_ARM64_DOVETAIL_H */
diff --git a/arch/arm64/kernel/Makefile b/arch/arm64/kernel/Makefile
index 83bd4c8cbb0..e6573b1c0fe 100644
--- a/arch/arm64/kernel/Makefile
+++ b/arch/arm64/kernel/Makefile
@@ -49,7 +49,6 @@ obj-$(CONFIG_ACPI_NUMA)			+= acpi_numa.o
 obj-$(CONFIG_ARM64_ACPI_PARKING_PROTOCOL)	+= acpi_parking_protocol.o
 obj-$(CONFIG_PARAVIRT)			+= paravirt.o
 obj-$(CONFIG_IRQ_PIPELINE)		+= irq_pipeline.o
-obj-$(CONFIG_DOVETAIL)			+= dovetail.o
 obj-$(CONFIG_RANDOMIZE_BASE)		+= kaslr.o
 obj-$(CONFIG_HIBERNATION)		+= hibernate.o hibernate-asm.o
 obj-$(CONFIG_KEXEC_CORE)		+= machine_kexec.o relocate_kernel.o	\
diff --git a/arch/arm64/kernel/dovetail.c b/arch/arm64/kernel/dovetail.c
deleted file mode 100644
index 9c6235a1622..00000000000
--- a/arch/arm64/kernel/dovetail.c
+++ /dev/null
@@ -1,12 +0,0 @@
-/*
- * SPDX-License-Identifier: GPL-2.0
- *
- * Copyright (C) 2018 Philippe Gerum  <rpm@xenomai.org>.
- */
-#include <linux/dovetail.h>
-#include <asm/fpsimd.h>
-
-void arch_dovetail_switch_finish(bool enter_inband)
-{
-	fpsimd_restore_current_oob();
-}
-- 
2.16.4

