From de484a730fef8c19f2c65da73bedca240d2c3092 Mon Sep 17 00:00:00 2001
From: Philippe Gerum <rpm@xenomai.org>
Date: Tue, 1 Oct 2019 11:36:58 +0200
Subject: [PATCH] x86: irq_pipeline: convert to handle_irq_pipelined()

Signed-off-by: Philippe Gerum <rpm@xenomai.org>
---
 arch/x86/include/asm/irq_pipeline.h |  2 ++
 arch/x86/kernel/irq_pipeline.c      | 10 +++++++---
 2 files changed, 9 insertions(+), 3 deletions(-)

diff --git a/arch/x86/include/asm/irq_pipeline.h b/arch/x86/include/asm/irq_pipeline.h
index 756c80d6dfc9..163bd20dda51 100644
--- a/arch/x86/include/asm/irq_pipeline.h
+++ b/arch/x86/include/asm/irq_pipeline.h
@@ -96,6 +96,8 @@ unsigned long pipelined_fault_entry(int trapnr, struct pt_regs *regs);
 
 void pipelined_fault_exit(unsigned long combo);
 
+void handle_arch_irq(struct pt_regs *regs);
+
 #else /* !CONFIG_IRQ_PIPELINE */
 
 struct pt_regs;
diff --git a/arch/x86/kernel/irq_pipeline.c b/arch/x86/kernel/irq_pipeline.c
index 174336dbf3d9..452a28698949 100644
--- a/arch/x86/kernel/irq_pipeline.c
+++ b/arch/x86/kernel/irq_pipeline.c
@@ -175,7 +175,7 @@ void arch_do_IRQ_pipelined(struct irq_desc *desc)
 	set_irq_regs(old_regs);
 }
 
-__visible unsigned int __irq_entry handle_arch_irq_pipelined(struct pt_regs *regs)
+void handle_arch_irq(struct pt_regs *regs)
 {
 	unsigned int irq, vector = ~regs->orig_ax;
 	struct irq_desc *desc;
@@ -186,14 +186,18 @@ __visible unsigned int __irq_entry handle_arch_irq_pipelined(struct pt_regs *reg
 		desc = __this_cpu_read(vector_irq[vector]);
 		if (unlikely(desc == NULL)) {
 			pr_err("IRQ pipeline: unhandled vector %#.2x\n", vector);
-			return 0;
+			return;
 		}
 		irq = irq_desc_get_irq(desc);
 	}
 
 	generic_pipeline_irq(irq, regs);
+}
 
-	return leave_irq_pipeline(regs);
+__visible unsigned int __irq_entry
+handle_arch_irq_pipelined(struct pt_regs *regs)
+{
+	return handle_irq_pipelined(regs);
 }
 
 static int sipic_irq_map(struct irq_domain *d, unsigned int irq,
-- 
2.16.4

