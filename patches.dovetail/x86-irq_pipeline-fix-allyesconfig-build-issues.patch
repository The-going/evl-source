From b1dca8cc7ed25fd5cc2575c1379bb195140d6ca5 Mon Sep 17 00:00:00 2001
From: Philippe Gerum <rpm@xenomai.org>
Date: Mon, 27 May 2019 17:00:01 +0200
Subject: [PATCH] x86: irq_pipeline: fix allyesconfig build issues

---
 arch/x86/include/asm/irq_pipeline.h | 8 ++++++++
 arch/x86/kernel/traps.c             | 1 +
 include/linux/irq_pipeline.h        | 1 +
 3 files changed, 10 insertions(+)

diff --git a/arch/x86/include/asm/irq_pipeline.h b/arch/x86/include/asm/irq_pipeline.h
index f4ae6d9c3b20..756c80d6dfc9 100644
--- a/arch/x86/include/asm/irq_pipeline.h
+++ b/arch/x86/include/asm/irq_pipeline.h
@@ -32,6 +32,8 @@ unsigned long arch_irqs_native_to_virtual_flags(unsigned long flags)
 	return hard_irqs_disabled_flags(flags) << X86_EFLAGS_SS_BIT;
 }
 
+#ifndef CONFIG_PARAVIRT_XXL
+
 static inline notrace unsigned long arch_local_irq_save(void)
 {
 	int stalled = inband_irq_save();
@@ -64,6 +66,8 @@ static inline notrace void arch_local_irq_restore(unsigned long flags)
 	barrier();
 }
 
+#endif /* !CONFIG_PARAVIRT_XXL */
+
 static inline
 void arch_save_timer_regs(struct pt_regs *dst,
 			  struct pt_regs *src, bool oob_context)
@@ -96,6 +100,8 @@ void pipelined_fault_exit(unsigned long combo);
 
 struct pt_regs;
 
+#ifndef CONFIG_PARAVIRT_XXL
+
 static inline notrace unsigned long arch_local_save_flags(void)
 {
 	return native_save_fl();
@@ -126,6 +132,8 @@ static inline notrace unsigned long arch_local_irq_save(void)
 	return flags;
 }
 
+#endif /* !CONFIG_PARAVIRT_XXL */
+
 static inline
 unsigned long pipelined_fault_entry(int trapnr, struct pt_regs *regs)
 {
diff --git a/arch/x86/kernel/traps.c b/arch/x86/kernel/traps.c
index a108f180fec1..5d2514e7e1c2 100644
--- a/arch/x86/kernel/traps.c
+++ b/arch/x86/kernel/traps.c
@@ -14,6 +14,7 @@
 
 #include <linux/context_tracking.h>
 #include <linux/interrupt.h>
+#include <linux/irq_pipeline.h>
 #include <linux/kallsyms.h>
 #include <linux/spinlock.h>
 #include <linux/kprobes.h>
diff --git a/include/linux/irq_pipeline.h b/include/linux/irq_pipeline.h
index 020dbb0c3f83..b936d0049bae 100644
--- a/include/linux/irq_pipeline.h
+++ b/include/linux/irq_pipeline.h
@@ -73,6 +73,7 @@ extern struct irq_domain *synthetic_irq_domain;
 #else /* !CONFIG_IRQ_PIPELINE */
 
 #include <linux/irqstage.h>
+#include <asm/irq_pipeline.h>
 
 static inline
 void irq_pipeline_init_early(void) { }
-- 
2.16.4

