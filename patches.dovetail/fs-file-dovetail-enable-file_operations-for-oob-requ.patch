From 566c249de98eeb451f781211430e4702cf6ab2d2 Mon Sep 17 00:00:00 2001
From: Philippe Gerum <rpm@xenomai.org>
Date: Sun, 13 Jan 2019 10:36:09 +0100
Subject: [PATCH] fs/file: dovetail: enable file_operations for oob request
 handling

---
 fs/file.c                |  7 +++++++
 include/linux/dovetail.h | 25 +++++++++++++++++++++++++
 include/linux/fs.h       |  6 ++++++
 include/linux/poll.h     |  7 +++++++
 kernel/dovetail.c        | 15 +++++++++++++++
 5 files changed, 60 insertions(+)

diff --git a/fs/file.c b/fs/file.c
index 3da91a112bab..d4fbe05210ab 100644
--- a/fs/file.c
+++ b/fs/file.c
@@ -385,6 +385,7 @@ static struct fdtable *close_files(struct files_struct * files)
 			if (set & 1) {
 				struct file * file = xchg(&fdt->fd[i], NULL);
 				if (file) {
+					uninstall_inband_fd(i, file, files);
 					filp_close(file, files);
 					cond_resched();
 				}
@@ -597,6 +598,7 @@ void __fd_install(struct files_struct *files, unsigned int fd,
 		fdt = files_fdtable(files);
 		BUG_ON(fdt->fd[fd] != NULL);
 		rcu_assign_pointer(fdt->fd[fd], file);
+		install_inband_fd(fd, file, files);
 		spin_unlock(&files->file_lock);
 		return;
 	}
@@ -605,6 +607,7 @@ void __fd_install(struct files_struct *files, unsigned int fd,
 	fdt = rcu_dereference_sched(files->fdt);
 	BUG_ON(fdt->fd[fd] != NULL);
 	rcu_assign_pointer(fdt->fd[fd], file);
+	install_inband_fd(fd, file, files);
 	rcu_read_unlock_sched();
 }
 
@@ -632,6 +635,7 @@ int __close_fd(struct files_struct *files, unsigned fd)
 		goto out_unlock;
 	rcu_assign_pointer(fdt->fd[fd], NULL);
 	__put_unused_fd(files, fd);
+	uninstall_inband_fd(fd, file, files);
 	spin_unlock(&files->file_lock);
 	return filp_close(file, files);
 
@@ -659,6 +663,7 @@ int __close_fd_get_file(unsigned int fd, struct file **res)
 		goto out_unlock;
 	rcu_assign_pointer(fdt->fd[fd], NULL);
 	__put_unused_fd(files, fd);
+	uninstall_inband_fd(fd, file, files);
 	spin_unlock(&files->file_lock);
 	get_file(file);
 	*res = file;
@@ -696,6 +701,7 @@ void do_close_on_exec(struct files_struct *files)
 				continue;
 			rcu_assign_pointer(fdt->fd[fd], NULL);
 			__put_unused_fd(files, fd);
+			uninstall_inband_fd(fd, file, files);
 			spin_unlock(&files->file_lock);
 			filp_close(file, files);
 			cond_resched();
@@ -872,6 +878,7 @@ __releases(&files->file_lock)
 		__set_close_on_exec(fd, fdt);
 	else
 		__clear_close_on_exec(fd, fdt);
+	replace_inband_fd(fd, file, files);
 	spin_unlock(&files->file_lock);
 
 	if (tofree)
diff --git a/include/linux/dovetail.h b/include/linux/dovetail.h
index b9a48597e904..d924f4358c08 100644
--- a/include/linux/dovetail.h
+++ b/include/linux/dovetail.h
@@ -14,6 +14,8 @@
 
 struct pt_regs;
 struct task_struct;
+struct file;
+struct files_struct;
 
 enum inband_event_type {
 	INBAND_TASK_SCHEDULE,
@@ -203,8 +205,19 @@ static inline void dovetail_send_mayday(struct task_struct *castaway)
 		set_ti_thread_flag(ti, TIF_MAYDAY);
 }
 
+void install_inband_fd(unsigned int fd, struct file *file,
+		       struct files_struct *files);
+
+void uninstall_inband_fd(unsigned int fd, struct file *file,
+			 struct files_struct *files);
+
+void replace_inband_fd(unsigned int fd, struct file *file,
+		       struct files_struct *files);
+
 #else	/* !CONFIG_DOVETAIL */
 
+struct files_struct;
+
 static inline
 void inband_task_init(struct task_struct *p) { }
 
@@ -247,6 +260,18 @@ static inline int inband_switch_tail(void)
 
 static inline void inband_clock_was_set(void) { }
 
+static inline
+void install_inband_fd(unsigned int fd, struct file *file,
+		       struct files_struct *files) { }
+
+static inline
+void uninstall_inband_fd(unsigned int fd, struct file *file,
+			 struct files_struct *files) { }
+
+static inline
+void replace_inband_fd(unsigned int fd, struct file *file,
+		       struct files_struct *files) { }
+
 #endif	/* !CONFIG_DOVETAIL */
 
 static inline bool dovetailing(void)
diff --git a/include/linux/fs.h b/include/linux/fs.h
index 997a530ff4e9..06696840623d 100644
--- a/include/linux/fs.h
+++ b/include/linux/fs.h
@@ -54,6 +54,7 @@ struct kiocb;
 struct kobject;
 struct pipe_inode_info;
 struct poll_table_struct;
+struct oob_poll_wait;
 struct kstatfs;
 struct vm_area_struct;
 struct vfsmount;
@@ -949,6 +950,7 @@ struct file {
 #endif
 	/* needed for tty driver, and maybe others */
 	void			*private_data;
+	void			*oob_data;
 
 #ifdef CONFIG_EPOLL
 	/* Used by fs/eventpoll.c to link all the hooks to this file */
@@ -1799,6 +1801,10 @@ struct file_operations {
 	__poll_t (*poll) (struct file *, struct poll_table_struct *);
 	long (*unlocked_ioctl) (struct file *, unsigned int, unsigned long);
 	long (*compat_ioctl) (struct file *, unsigned int, unsigned long);
+	ssize_t (*oob_read) (struct file *, char __user *, size_t);
+	ssize_t (*oob_write) (struct file *, const char __user *, size_t);
+	long (*oob_ioctl) (struct file *, unsigned int, unsigned long);
+	__poll_t (*oob_poll) (struct file *, struct oob_poll_wait *);
 	int (*mmap) (struct file *, struct vm_area_struct *);
 	unsigned long mmap_supported_flags;
 	int (*open) (struct inode *, struct file *);
diff --git a/include/linux/poll.h b/include/linux/poll.h
index 1cdc32b1f1b0..09fd27887fd5 100644
--- a/include/linux/poll.h
+++ b/include/linux/poll.h
@@ -110,6 +110,13 @@ struct poll_wqueues {
 	struct poll_table_entry inline_entries[N_INLINE_POLL_ENTRIES];
 };
 
+/*
+ * Generic poll operation descriptor for f_op->oob_poll.
+ */
+struct oob_poll_wait {
+	struct list_head next;
+};
+
 extern void poll_initwait(struct poll_wqueues *pwq);
 extern void poll_freewait(struct poll_wqueues *pwq);
 extern u64 select_estimate_accuracy(struct timespec64 *tv);
diff --git a/kernel/dovetail.c b/kernel/dovetail.c
index 339824578307..785e7bbb1860 100644
--- a/kernel/dovetail.c
+++ b/kernel/dovetail.c
@@ -339,6 +339,21 @@ void __weak inband_clock_was_set(void)
 {
 }
 
+void __weak install_inband_fd(unsigned int fd, struct file *file,
+			      struct files_struct *files)
+{
+}
+
+void __weak uninstall_inband_fd(unsigned int fd, struct file *file,
+				struct files_struct *files)
+{
+}
+
+void __weak replace_inband_fd(unsigned int fd, struct file *file,
+			      struct files_struct *files)
+{
+}
+
 int dovetail_start(void)
 {
 	check_inband_stage();
-- 
2.16.4

