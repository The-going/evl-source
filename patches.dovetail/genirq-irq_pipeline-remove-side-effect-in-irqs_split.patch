From b8979e8351bdf4663f0d09d84d62298c7c2c524c Mon Sep 17 00:00:00 2001
From: Philippe Gerum <rpm@xenomai.org>
Date: Sat, 27 Apr 2019 11:56:04 +0200
Subject: [PATCH] genirq: irq_pipeline: remove side-effect in
 irqs_split_flags()

---
 include/asm-generic/irq_pipeline.h | 5 +++--
 1 file changed, 3 insertions(+), 2 deletions(-)

diff --git a/include/asm-generic/irq_pipeline.h b/include/asm-generic/irq_pipeline.h
index 857dd9318169..d818ebfd9f8e 100644
--- a/include/asm-generic/irq_pipeline.h
+++ b/include/asm-generic/irq_pipeline.h
@@ -50,9 +50,10 @@ void irq_pipeline_nmi_exit(void);
 /* Extract swap virtual and hardware interrupt states. */
 #define irqs_split_flags(__combo, __stall_r)				\
 	({								\
+		unsigned long __virt = (__combo);			\
 		*(__stall_r) = hard_irqs_disabled_flags(__combo);	\
-		__combo &= ~arch_irqs_virtual_to_native_flags(*(__stall_r)); \
-		arch_irqs_virtual_to_native_flags(__combo);		\
+		__virt &= ~arch_irqs_virtual_to_native_flags(*(__stall_r)); \
+		arch_irqs_virtual_to_native_flags(__virt);		\
 	})
 
 #else /* !CONFIG_IRQ_PIPELINE */
-- 
2.16.4

