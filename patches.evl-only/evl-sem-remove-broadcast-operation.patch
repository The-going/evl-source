From e09a54e0b17b49f8808fcaa44156da1d5204183e Mon Sep 17 00:00:00 2001
From: Philippe Gerum <rpm@xenomai.org>
Date: Wed, 6 Feb 2019 15:19:56 +0100
Subject: [PATCH] evl/sem: remove broadcast operation

---
 include/uapi/evenless/sem.h |  3 +--
 kernel/evenless/sem.c       | 15 +--------------
 2 files changed, 2 insertions(+), 16 deletions(-)

diff --git a/include/uapi/evenless/sem.h b/include/uapi/evenless/sem.h
index bcfda6bd2bc..2e841b29a8b 100644
--- a/include/uapi/evenless/sem.h
+++ b/include/uapi/evenless/sem.h
@@ -38,7 +38,6 @@ struct evl_sem_waitreq {
 
 #define EVL_SEMIOC_GET		_IOW(EVL_SEM_IOCBASE, 0, __u32)
 #define EVL_SEMIOC_PUT		_IOW(EVL_SEM_IOCBASE, 1, __u32)
-#define EVL_SEMIOC_BCAST	_IO(EVL_SEM_IOCBASE, 2)
-#define EVL_SEMIOC_BIND		_IOR(EVL_SEM_IOCBASE, 3, struct evl_element_ids)
+#define EVL_SEMIOC_BIND		_IOR(EVL_SEM_IOCBASE, 2, struct evl_element_ids)
 
 #endif /* !_EVENLESS_UAPI_SEM_H */
diff --git a/kernel/evenless/sem.c b/kernel/evenless/sem.c
index 1730455719c..ede8837b092 100644
--- a/kernel/evenless/sem.c
+++ b/kernel/evenless/sem.c
@@ -61,13 +61,11 @@ static int acquire_sem(struct evl_sem *sem,
 	timeout = timespec_to_ktime(req->timeout);
 	tmode = timeout ? EVL_ABS : EVL_REL;
 	info = evl_wait_timeout(&sem->wait_queue, timeout, tmode);
-	if (info & (T_BREAK|T_BCAST|T_TIMEO)) {
+	if (info & (T_BREAK|T_TIMEO)) {
 		atomic_add(req->count, &state->value);
 		ret = -ETIMEDOUT;
 		if (info & T_BREAK)
 			ret = -EINTR;
-		else if (info & T_BCAST)
-			ret = -EAGAIN;
 	} /* No way we could receive T_RMID */
 out:
 	xnlock_put_irqrestore(&nklock, flags);
@@ -126,14 +124,6 @@ static int release_sem(struct evl_sem *sem, int count)
 	return 0;
 }
 
-static int broadcast_sem(struct evl_sem *sem)
-{
-	evl_flush_wait(&sem->wait_queue, T_BCAST);
-	evl_schedule();
-
-	return 0;
-}
-
 static long sem_common_ioctl(struct evl_sem *sem,
 			unsigned int cmd, unsigned long arg)
 {
@@ -147,9 +137,6 @@ static long sem_common_ioctl(struct evl_sem *sem,
 			return -EFAULT;
 		ret = release_sem(sem, count);
 		break;
-	case EVL_SEMIOC_BCAST:
-		ret = broadcast_sem(sem);
-		break;
 	default:
 		ret = -ENOTTY;
 	}
-- 
2.16.4

