From 2b491af2a694438f8308efe627f394b0f3b3105e Mon Sep 17 00:00:00 2001
From: Philippe Gerum <rpm@xenomai.org>
Date: Mon, 27 Jan 2020 10:46:41 +0100
Subject: [PATCH] evl/work: synchronize on flag instead of sema4

---
 include/evl/work.h | 4 ++--
 kernel/evl/work.c  | 6 +++---
 2 files changed, 5 insertions(+), 5 deletions(-)

diff --git a/include/evl/work.h b/include/evl/work.h
index 8494b596feab..32f2e4a66290 100644
--- a/include/evl/work.h
+++ b/include/evl/work.h
@@ -9,7 +9,7 @@
 
 #include <linux/irq_work.h>
 #include <linux/workqueue.h>
-#include <evl/sem.h>
+#include <evl/flag.h>
 
 struct evl_work {
 	struct irq_work irq_work;
@@ -20,7 +20,7 @@ struct evl_work {
 
 struct evl_sync_work {
 	struct evl_work work;
-	struct evl_ksem done;
+	struct evl_flag done;
 	int result;
 };
 
diff --git a/kernel/evl/work.c b/kernel/evl/work.c
index 07e7c577eb42..b4f3cd2fdd28 100644
--- a/kernel/evl/work.c
+++ b/kernel/evl/work.c
@@ -20,7 +20,7 @@ static void do_wq_work_sync(struct work_struct *wq_work)
 
 	sync_work = container_of(wq_work, struct evl_sync_work, work.wq_work);
 	sync_work->result = sync_work->work.handler(sync_work);
-	evl_up(&sync_work->done);
+	evl_raise_flag(&sync_work->done);
 }
 
 static void do_irq_work(struct irq_work *irq_work)
@@ -47,7 +47,7 @@ void evl_init_sync_work(struct evl_sync_work *sync_work,
 	init_irq_work(&work->irq_work, do_irq_work);
 	INIT_WORK(&work->wq_work, do_wq_work_sync);
 	work->handler = (typeof(work->handler))handler;
-	evl_init_ksem(&sync_work->done, 0);
+	evl_init_flag(&sync_work->done);
 }
 
 void evl_call_inband_from(struct evl_work *work,
@@ -72,5 +72,5 @@ int evl_call_inband_sync_from(struct evl_sync_work *sync_work,
 
 	evl_call_inband_from(work, wq);
 
-	return evl_down(&sync_work->done) ?: sync_work->result;
+	return evl_wait_flag(&sync_work->done) ?: sync_work->result;
 }
-- 
2.16.4

